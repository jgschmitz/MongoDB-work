db.authors.aggregate([
  {
    $lookup: {
      from: "books",  // Target collection
      localField: "_id",  // Field in `authors` collection
      foreignField: "authorId",  // Field in `books` collection
      as: "books"  // Output array
    }
  },
  // Add filtering for relevant books (e.g., published books only)
  {
    $project: {
      name: 1,
      books: {
        $filter: {
          input: "$books",
          as: "book",
          cond: { $eq: ["$$book.isPublished", true] }  // Include only published books
        }
      }
    }
  },
  // Further project only relevant fields in books
  {
    $project: {
      name: 1,
      books: {
        title: 1,
        genre: 1,
        publishedYear: 1  // Include more relevant fields
      }
    }
  },
  // Optionally, sort the books by published year (descending)
  {
    $addFields: {
      books: {
        $sortArray: { input: "$books", sortBy: { publishedYear: -1 } }  // Sort books by latest first
      }
    }
  },
  // Optional stage: Handle authors with no books, by ensuring the books array is present even if empty
  {
    $addFields: {
      books: {
        $ifNull: ["$books", []]  // Ensure an empty array instead of null if no books
      }
    }
  }
]);
